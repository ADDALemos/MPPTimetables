\section{Modeling}
\label{sec:model}
In this section, we present two different models to solve the university timetabling problem described above. Table~\ref{tab:encoding} summarizes the constraints used in the different models and the encoding for the most common disruptions.

\subsection{\textsc{Boolean} Model}
In the past, different integer-programming models have been proposed to solve university timetabling problems~\cite{LINDAHL2019}. These models typically use Boolean variables to indicate the assignment of lectures to rooms and time slots. These models can be easily generalized to solve the problem at hand. However, this model requires a quadratic number of constraints. 


%Lemos \emph{et al} proposed an \gls{ilp} encoding to optimize room usage in university timetabling problems. The encoding did not allow the modifications of the lectures scheduled. Therefore, this model had only one decision variable representing the assignment of a lecture to a room.  

%The proposed model can be easily generalized to deal with changes in schedule.  However, the new version of the model will require quadratic constraints. 
\vspace{-.5cm}

\subsubsection{Decision Variables}

The schedule of a lecture (day and time slots) is represented with an incidence matrix $a$, where $a^l_{d,t}$ equals 1 if and only if a lecture $l$ is scheduled in the time slot $t \in T_l$ of day $d \in D_l$. The assignment of a lecture to a room is represented by the Boolean variable $x_{l,r} \in \{0, 1\}$; it is equal to 1 if and only if the lecture $l \in L$ is assigned to room $r \in R$.
\vspace{-.5cm}

\subsubsection{Auxiliary Variables} The variable $c_{s,d,t}$ is equal to 1 if and only if a student's $s$ timetable has a transition from occupied (attending a lecture) to free or vice-versa.


\begin{comment}
c_{s,d,t}= \begin{cases}
  1 & \textrm{if} \ \sum_{l \in S_l} a^{l_1}_{d,t-1} \neq  \sum_{l \in S_l} a^{l_1}_{d,t}\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{s\in S, d \in D, t \in T}.  
\end{comment}


\begin{comment}
\subsubsection{Constraints}
The constraints considered are as follows:
\begin{itemize}
\item {\em Lectures to time slots }: All lectures must be assigned to enough time slots. Formally,
\begin{equation}
\sum_{d \in  D_l}\sum_{t \in  T_l} A^l_{d,t} = len_l \forall_{l \in L}.
\end{equation}
\item {\em Consecutive time }: A lecture must be taught in consecutive time slots in the same day. Formally,
\begin{equation}
 A^l_{d,t_1} =  \begin{cases}
  1 & \textrm{if} \ A^l_{d,t} - A^l_{d,t_2} = 0\\
  0 & \textrm{otherwise}  \end{cases} \forall_{l \in L, d \in D, t, t_1, t_2 \in T, t < t_1 < t_2}.
\end{equation}
\item {\em Lectures to rooms }: All lectures must be assigned to rooms. Formally,
\begin{equation}
    \sum_{r \in R_l} x_{l,r}  = 1 \forall_{l\in L}
\end{equation}
\item {\em Student Conflicts}: All students must be able to attend the lectures for which they are enrolled in. Formally,
%
\begin{equation}
\sum_{l\in L_s} A^l_{d,t}\leq 1 \forall_{s\in S,d\in D, t \in T} .
%\forall_{r\in R}\forall_{l\in assign(l,r)} Cap(r)\geq Students(l)
\end{equation}
\item {\em Room Conflicts}: A room can have at most one lecture scheduled per time slot per day. Formally,
\begin{equation}
\sum_{l\in L} x_{l,r} \times A^l_{d,t}\leq 1 \forall_{r\in R,d\in D, t \in T} .\label{const1}
\end{equation}
\item {\em Teacher Conflicts}: At-most $over$ lectures from the same course can be lectured at the same time. Formally,
%
\begin{equation}
\sum_{L_c^{i} \in L_c} \sum_{l \in L_c^{i}} A^l_{d,t}\leq over_{L_c^{i}} \forall_{d\in D, t\in T, c \in C} .
%\forall_{r\in R}\forall_{l\in assign(l,r)} Cap(r)\geq Students(l)
\end{equation}
\item {\em Capacity}: 
%
\begin{equation}
 (std_l - std_l \times \alpha) \times x_{l,r} \leq cap_r \forall_{l\in L,r\in R} .
%\forall_{r\in R}\forall_{l\in assign(l,r)} Cap(r)\geq Students(l)
\end{equation}
\end{itemize}
\end{comment}

\begin{table}[t]
\centering
\caption{Constraints in the \textsc{boolean} and \textsc{mixed} models.}
\label{tab:encoding}
\resizebox{\textwidth}{!}{%
\begin{tabular}{|c|c|c|}
\hline
  & \textsc{boolean}                                                                                                                                                                                                                    & \textsc{mixed} \\ \hline

1.         & $\forall_{l \in L} \sum_{d \in,D_l}\sum_{t \in,T_l} a^l_{d,t} = len_l$                                                                                                                                                      &  $\forall_{l\in L} \ a^l \geq 0 $     \\\hline

\multirow{2}{*}{2.}         & $\forall_{l \in L, d \in D, t, t_1, t_2 \in T, t < t_1 < t_2}$ &   $\forall_{l\in L}$        \\ 

 & $a^l_{d,t_1} =1  \ \textrm{iff} \ a^l_{d,t} - a^l_{d,t_2} = 0$  &  $a^l + len_l \leq  \textrm{floor}(\frac{a^l}{|T|}+1) \times (|T|-1) $    \\\hline

3.         & $\forall_{l\in L} \sum_{r \in R_l} x_{l,r},= 1$                                                                                                                                                                           &      $ \forall_{l\in L} \ \sum_{r \in R_l} x_{l,r}  = 1$    \\ \hline

\multirow{2}{*}{4.}         &$\forall_{s\in S,d\in D, t \in T} $                                                                                                                                                    & $\forall_{l_1\in L_s, l_2\in L_s, s\in S}$         \\
   &    $\sum_{l\in L_s} a^l_{d,t}\leq 1 $                                                                                                                                                 &  $v_{l_1,l_2} + v_{l_2,l_1} \leq 1$  \\\hline

\multirow{2}{*}{5.}           &  $ \forall_{r\in R,d\in D, t \in T}$  &  $\forall_{l_1\in L, l_2\in L}$    \\

  &  $\sum_{l\in L} x_{l,r} \times a^l_{d,t}\leq 1 $                                                                                                                     & $s_{l_1,l_2} \times (v_{l_1,l_2} + v_{l_2,l_1}) \leq  s_{l_1,l_2} $     \\\hline

\multirow{2}{*}{6.} & $ \forall_{d\in D, t\in T, c \in C} $                                                                                                               &  $ \forall_{c \in C} $             \\

          & $\sum_{\mathcal{L}_c^{i} \in L_c} \sum_{l \in \mathcal{L}_c^{i}} a^l_{d,t}\leq over_{\mathcal{L}_c^{i}} $                                                                                                            &  $\sum_{\mathcal{L}_c^{i} \in L_c} \sum_{l_1,l_2 \in \mathcal{L}_c^{i}} o_{l_1,l_2} \leq over_{\mathcal{L}_c^{i}} $      \\\hline

7.     &     $\forall_{l\in L,r\in R} \ (std_l - std_l \times \alpha) \times x_{l,r} \leq cap_r$ &   $ \forall_{l\in L,r\in R} \ (std_l - std_l \times \alpha) \times x_{l,r} \leq cap_r $                                                                                                                             \\ \hline
8. & $\sum_{s \in S}\sum_{d \in D}\sum_{t \in T} c_{s,d,t}$ & $\sum_{s \in S}\sum_{l \in S_l} c_{s,l}$\\\hline
9. & $ a^l_r = -1 $ &$x_{l,r} = 0$\\\hline
10. & $a^l_{d,t} = 0$ &$ a^l \ != (d \times |T|) + t$ \\\hline
\end{tabular}}
%\vspace{-.5cm}
\end{table}


%\subsection{Encoding Disruptions}
%In this section, we describe the new constraints required to encode the different constraint type disruptions.
%\begin{itemize}
%\item {\em No overlap conditions for lectures $l_1$ and $l_2$}: $\>$ $A^{l_1}_{d,t} + A^{l_2}_{d,t} \leq 1 \hfill \refstepcounter{equation}(\theequation)\label{eq:p:overlap}$
%\item {\em Invalid assignment for lecture $l$}: $\>$ $x_{l,r} + A^l_{d,t} \leq 1 \hfill \refstepcounter{equation}(\theequation)\label{eq:p:invalidassigment}$
%\item {\em Invalid time assignment for lecture $l$}: $\>$ $A^l_{d,t} = 0 \hfill \refstepcounter{equation}(\theequation)\label{eq:p:invalidtime}$
%\item {\em Preference time for lecture $l$}: $\>$ $A^l_{d,t} = 1  \hfill \refstepcounter{equation}(\theequation)\label{eq:p:preferenceTime}$
%\item {\em Invalid room assignment for lecture $l$}: $\>$ $x_{l,r} = 0  \hfill \refstepcounter{equation}(\theequation)\label{eq:p:invalidRoom}$
%\item {\em Room preference for lecture $l$}:$\>$  $x_{l,r} = 1 \hfill \refstepcounter{equation}(\theequation)\label{eq:p:preferedRoom}$
%\item {\em Remove room for a day $d$}: $\>$ %$\sum_{t\in T} x_{l,r} \times A^l_{d,t} = 0  \hfill \refstepcounter{equation}(\theequation)\label{eq:p:removeRoom}$
%\end{itemize}
\begin{comment}


\subsection{\textsc{Integer} Model} \todo{Remove this model ?}

Lindahl \emph{et al.}~\cite{LINDAHL2019} proposed a model to solve university timetabling problems from \gls{itc}-2007 competition. The models from \gls{itc}-2007 are considerably simpler. For example, they consider all lectures have the same unitary duration. Nevertheless, this model can be extended to allow courses with different duration's. This model requires fewer variables than the Boolean Model.

\subsubsection{Decision Variables}
The starting time slot of a lecture $l$ in a room $r$ is represented by an integer variable $a^l_r \in {-1, \ldots, |P|}$. 

\subsubsection{Auxiliary Variables} The variable $v_{r,l_1,l_2}$ is equal to 1 if and only if $l_1$ is taught before $l_2$.

\begin{equation}
v_{r,l_1,l_2}= \begin{cases}
  1 & \textrm{if} \ a^{l_1}_r + len_{l_1} \leq a^{l_2}_r\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{r \in R_l, l_1\in L, l_2\in L}.  
\end{equation}

The variable $o_{l_1,l_2}$ is equal to 1 if and only if $l_1$ is taught at the same time as $l_2$. 
\begin{equation}
o_{r, l_1,l_2}= \begin{cases}
  1 & \textrm{if} \  v_{r,l_1,l_2} + v_{r,l_2,l_1} = 0\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{r \in R_l, l_1\in L, l_2\in L}.  
\end{equation}
 The variable $g_{l_1,l_2,s}$ is equal to 1 if and only if $l_2$ starts when $l_1$ just ended. 
\begin{equation}
g_{l_1,l_2,s}= \begin{cases}
  1 & \textrm{if} \  a^{l_1} + len_{l_1} = a^{l_2}\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l_1\in S_l, l_2\in S_l, s\in S}.  
\end{equation}
Finally, the variable $c_{l,s} \in \{0,1,2\}$ represents the number of gaps in student $s$ timetable near lecture $l$. 
\begin{equation}
c_{l,s}= \begin{cases}
  1 & \textrm{if} \  \sum_{l_2 \in S_l}v_{l,l_2} + \sum_{l_2 \in S_l} v_{l_2,l}\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l\in S_l, s\in S}.  
\end{equation}

\subsubsection{Constraints}
The constraints considered are as follows:
\begin{itemize}
\item {\em Lectures to time slots }:
\begin{equation}
 \sum{r \in R} A^l_r \geq 0 \ \forall_{l\in L}
\end{equation}
\item {\em Consecutive time }: Ensure the lecture is taught in the same day
\begin{equation}
  A^l_r + len_l \leq  \textrm{floor}(\frac{A^l_r}{|T|}+1) \times (|T|-1) \ \forall_{r \in R, l\in L}.
\end{equation}
\item {\em Lectures to rooms }:
\begin{equation}
    \sum_{r \in R_l} A^l_r  = 1 \ \forall_{l\in L}.
\end{equation}
\item {\em Student Conflicts}: 
\begin{equation}
V_{r,l_1,l_2} + V_{r,l_2,l_1} \leq 1\forall_{r \in R_l, l_1\in L_s, l_2\in L_s, s\in S}.
\end{equation}
%
\begin{equation}
V_{r,l_1,l_2}= \begin{cases}
  1 & \textrm{if} \ A^{l_1}_r + len_{l_1} \leq A^{l_2}_r\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{r \in R_l, l_1\in L, l_2\in L}.  
\end{equation}
\item {\em Room Conflicts}:
\begin{equation}
V_{r,l_1,l_2} + V_{r,l_2,l_1} \leq  1 \forall_{r \in R_l, l_1\in L, l_2\in L}. 
\end{equation}
\item {\em Teacher Conflicts}:
\begin{equation}
\sum_{L_c^{i} \in L_c} \sum_{l_1,l_2 \in L_c^{i}} \sum_{r \in R} O_{r, l_1,l_2} \leq over_{L_c^{i}} \forall_{c \in C} .
\end{equation}
\begin{equation}
O_{r, l_1,l_2}= \begin{cases}
  1 & \textrm{if} \  V_{r,l_1,l_2} + V_{r,l_2,l_1} = 0\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{r \in R_l, l_1\in L, l_2\in L}.  
\end{equation}
\item {\em Capacity}: 

\begin{equation}
 (std_l - std_l \times \alpha) \times A^l_r \leq cap_r \forall_{l\in L,r\in R} .
%\forall_{r\in R}\forall_{l\in assign(l,r)} Cap(r)\geq Students(l)
\end{equation}
\end{itemize}
\end{comment}
\subsection{\textsc{Mixed} Model}

The \textsc{mixed} model, uses a Boolean variable for the assignment of rooms and an integer variable for the schedule.

The global number of variables of the \textsc{mixed} model is smaller when compared to the \textsc{Boolean} model since we only need an integer variable for each lecture instead of a Boolean variable for each time slot. This model allows removing some constraints from the \textsc{Boolean} model. The implementation ensures that the constraint of {\em room conflicts} is not quadratic through the use of auxiliary variables.

%The mixed model has an advantage, over the integer model, of separating the constraints for room and time slots into two different sets. This causes the constraints to be simpler. The simplification also allows the usage of iterative algorithms.

\vspace{-.5cm}


\subsubsection{Decision Variables}

The starting time slot of a lecture $l$ is represented by an integer variable $a^l \in [0, \ldots, |P|]$. The assignment of a lecture to a room is described by the Boolean variable $x_{l,r} \in \{0, 1\}$. It is equal to 1 if and only if lecture $l \in L$ is assigned to room $r \in R$. 

\vspace{-.5cm}


\subsubsection{Auxiliary Variables} Variable $v_{l_1,l_2}$ is equal to 1 if and only if $l_1$ is taught before $l_2$. 
\begin{comment}
v_{l_1,l_2}= \begin{cases}
  1 & \textrm{if} \ a^{l_1} + len_{l_1} \leq a^{l_2}\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l_1\in L, l_2\in L}.  
\end{comment}
Variable $o_{l_1,l_2}$ is equal to 1 if and only if $l_1$ is taught at the same time as $l_2$.
\begin{comment}
o_{l_1,l_2}= \begin{cases}
  1 & \textrm{if} \  v_{l_1,l_2} + v_{l_2,l_1} = 0\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l_1\in L, l_2\in L}.  
\end{comment}
Variable $s_{l_1,l_2}$ is equal to 1 if and only if $l_1$ is taught in the same room that $l_2$. 
\begin{comment}
s_{l_1,l_2}= \begin{cases}
  1 & \textrm{if} \ x_{l_1,r} = x_{l_2,r}\\
  0 & \textrm{otherwise}  \end{cases}   \forall_{l_1\in L, l_2\in L, r \in R}.
\end{comment}
Variable $g_{l_1,l_2,s}$ is equal to 1 if and only if $l_2$ starts when $l_1$ just ended (consecutive). Finally, variable $c_{l,s} \in \{0,1,2\}$ represents the number of transitions from free to occupied in a student's $s$ timetable before/after lecture $l$. 
\begin{comment}
g_{l_1,l_2,s}= \begin{cases}
  1 & \textrm{if} \  a^{l_1} + len_{l_1} = a^{l_2}\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l_1\in S_l, l_2\in S_l, s\in S}.  
\end{comment}
%Finally, the variable $c_{l,s} \in \{0,1,2\}$ which represents the number of gaps in student $s$ timetable near lecture $l$. 
\begin{comment}
c_{l,s}= \begin{cases}
  1 & \textrm{if} \  \sum_{l_2 \in S_l}v_{l,l_2} + \sum_{l_2 \in S_l} v_{l_2,l}\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l\in S_l, s\in S}.  
\end{comment}


\begin{comment}
\subsubsection{Constraints}
The constraints considered are as follows:
\begin{itemize}
\item {\em Lectures to time slots }:
\begin{equation}
 A^l \geq 0 \ \forall_{l\in L}
\end{equation}
\item {\em Consecutive time }: Ensure the lecture is taught in the same day
\begin{equation}
 A^l + len_l \leq  \textrm{floor}(\frac{A^l}{|T|}+1) \times (|T|-1) \ \forall_{l\in L}.
\end{equation}
\item {\em Lectures to rooms }:
\begin{equation}
    \sum_{r \in R_l} x_{l,r}  = 1 \ \forall_{l\in L}.
\end{equation}
\item {\em Student Conflicts}: 
\begin{equation}
V_{l_1,l_2} + V_{l_2,l_1} \leq 1\forall_{l_1\in L_s, l_2\in L_s, s\in S}.
\end{equation}
%
\begin{equation}
V_{l_1,l_2}= \begin{cases}
  1 & \textrm{if} \ A^{l_1} + len_{l_1} \leq A^{l_2}\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l_1\in L, l_2\in L}.  
\end{equation}
\item {\em Room Conflicts}:
\begin{equation}
S_{l_1,l_2} \times (V_{l_1,l_2} + V_{l_2,l_1}) \leq  S_{l_1,l_2} \forall_{l_1\in L, l_2\in L}. 
\end{equation}
\begin{equation}
S_{l_1,l_2}= \begin{cases}
  1 & \textrm{if} \ x_{l_1,r} = x_{l_2,r}\\
  0 & \textrm{otherwise}  \end{cases}   \forall_{l_1\in L, l_2\in L, r \in R}.
\end{equation}
\item {\em Teacher Conflicts}:
\begin{equation}
\sum_{L_c^{i} \in L_c} \sum_{l_1,l_2 \in L_c^{i}} O_{l_1,l_2} \leq over_{L_c^{i}} \forall_{c \in C} .
\end{equation}
\begin{equation}
O_{l_1,l_2}= \begin{cases}
  1 & \textrm{if} \  V_{l_1,l_2} + V_{l_2,l_1} = 0\\
  0 & \textrm{otherwise}  \end{cases}  \forall_{l_1\in L, l_2\in L}.  
\end{equation}
\item {\em Capacity}: 

\begin{equation}
 (std_l - std_l \times \alpha) \times x_{l,r} \leq cap_r \forall_{l\in L,r\in R} .
%\forall_{r\in R}\forall_{l\in assign(l,r)} Cap(r)\geq Students(l)
\end{equation}
\end{itemize}
\end{comment}
